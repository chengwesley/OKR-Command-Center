<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OKR 戰情室</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/d3js/5.16.0/d3.min.js"></script> 
    
    <style>
        /* 自訂 scrollbar 樣式 */
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Modal 置中 */
        #modal-overlay {
            position: fixed;
            inset: 0;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 50;
        }

        #modal-content {
            background: #fff;
            border-radius: 12px;
            width: 90%;
            max-width: 720px;
            max-height: 80vh;
            padding: 1.5rem;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        /* 展開/收合箭頭動畫 */
        .collapse-arrow {
            transition: transform 0.2s ease-in-out;
        }

        .collapse-arrow.expanded {
            transform: rotate(90deg);
        }

        /* --- 全局與佈局樣式 --- */
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- D3 心智圖專用樣式 --- */
        #mindmap-container {
            width: 100%; height: calc(100vh - 10rem);
            min-height: 600px; overflow: hidden; background-color: #f7fafc;
            border: 1px solid #e2e8f0; border-radius: 0.5rem; cursor: grab;
        }
        #mindmap-container:active { cursor: grabbing; }

        .link { fill: none; stroke: #ccc; stroke-width: 1.5px; transition: all 0.3s ease-in-out; }
        .node { transition: opacity 0.3s ease-in-out; }
        .node text { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }

        /* 高亮與淡化效果 */
        .dimmed { opacity: 0.2; }
        .highlight-path { stroke: #3182ce !important; stroke-width: 3px !important; opacity: 1; }
        .node.highlight-search .card-bg { stroke: #dd6b20 !important; stroke-width: 3px !important; }
        .node.highlight-focus .card-bg { stroke: #38a169 !important; stroke-width: 3px !important; }

        /* Tooltip 富文本樣式 */
        .d3-tooltip {
            position: absolute; text-align: left; padding: 12px; font-family: sans-serif;
            font-size: 12px; background: rgba(40, 40, 40, 0.9); color: #fff;
            border: 0px; border-radius: 8px; pointer-events: none; opacity: 0;
            transition: opacity 0.2s ease-in-out; box-shadow: 0px 4px 12px rgba(0,0,0,0.4);
            max-width: 250px; line-height: 1.5em; z-index: 1000;
        }
        .d3-tooltip strong { display: block; margin-bottom: 8px; font-size: 14px; color: #fff; border-bottom: 1px solid #666; padding-bottom: 6px; }
        .d3-tooltip span { display: block; font-size: 11px; color: #ddd; margin-top: 4px; }
        .d3-tooltip hr { border: none; border-top: 1px solid #666; margin: 8px 0; }
        }
    </style>
</head>

<body class="bg-gray-100 flex h-screen overflow-hidden">

    <aside id="sidebar" class="w-64 bg-white shadow-lg flex flex-col hidden">
        <div class="h-20 flex items-center justify-center border-b">
            <h1 class="text-2xl font-semibold text-indigo-600">OKR 戰情室</h1>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button id="nav-company"
                class="w-full text-left px-4 py-2 rounded hover:bg-indigo-50 focus:bg-indigo-100 text-indigo-600 font-medium">公司級
                Objectives</button>
            <button id="nav-dept"
                class="w-full text-left px-4 py-2 rounded hover:bg-indigo-50 focus:bg-indigo-100 text-gray-700">部門級
                Objectives</button>
            <button id="nav-personal"
                class="w-full text-left px-4 py-2 rounded hover:bg-indigo-50 focus:bg-indigo-100 text-gray-700">我的
                Objectives</button>
            <button id="nav-approvals"
                class="w-full text-left px-4 py-2 rounded hover:bg-yellow-500 focus:bg-yellow-100 text-gray-700">審核中心</button>
            <button id="nav-mindmap"
                class="w-full text-left px-4 py-2 rounded hover:bg-gray-500 focus:bg-gray-100 text-gray-700">OKR
                心智圖</button>
            <button id="nav-reports"
                class="w-full text-left px-4 py-2 rounded hover:bg-gray-500 focus:bg-gray-100 text-gray-700">報表
                Dashboard</button>
        </nav>
        <div class="p-4 border-t">
            <button id="logout-button"
                class="w-full bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">登出</button>
        </div>
    </aside>

    <div class="flex-1 flex flex-col overflow-y-auto">
        <header id="header" class="h-16 bg-white shadow flex items-center px-6 hidden">
            <div class="flex-1">
                <span id="user-email-display" class="text-gray-600"></span>
            </div>
        </header>

        <main id="main-content" class="flex-1 p-6 space-y-6 hidden">
            <section id="section-company" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">公司級 Objectives</h2>
                    <button id="btn-create-company"
                        class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">新增公司級 O</button>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <input id="search-company" type="text" placeholder="搜尋標題或負責人"
                            class="border p-2 rounded w-64" />
                        <button id="btn-filter-company"
                            class="ml-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded">篩選</button>
                    </div>
                    <button id="btn-batch-update-company-KR"
                        class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">批次更新 KR 進度</button>
                </div>
                <div id="company-list" class="space-y-4"></div>
            </section>

            <section id="section-dept" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">部門級 Objectives</h2>
                    <button id="btn-create-dept"
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">新增部門級 O</button>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <input id="search-dept" type="text" placeholder="搜尋標題或部門"
                            class="border p-2 rounded w-64" />
                        <button id="btn-filter-dept"
                            class="ml-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded">篩選</button>
                    </div>
                    <button id="btn-batch-update-dept-KR"
                        class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">批次更新 KR 進度</button>
                </div>
                <div id="dept-list" class="space-y-4"></div>
            </section>

            <section id="section-personal" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">我的 Objectives</h2>
                    <button id="btn-create-personal"
                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">新增個人級 O</button>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <input id="search-personal" type="text" placeholder="搜尋標題"
                            class="border p-2 rounded w-64" />
                        <button id="btn-filter-personal"
                            class="ml-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded">篩選</button>
                    </div>
                    <button id="btn-batch-update-personal-KR"
                        class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">批次更新 KR 進度</button>
                </div>
                <div id="personal-list" class="space-y-4"></div>
            </section>

            <section id="section-approvals" class="hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">審核中心</h2>
                <div id="approvals-list" class="space-y-4"></div>
            </section>

            <section id="section-mindmap" class="hidden">
              <h2 class="text-2xl font-semibold text-gray-800 mb-4">OKR 心智圖</h2>
              <div id="mindmap-container"></div>
            </section>

            <section id="section-reports" class="hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">報表 Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white rounded-lg shadow p-6 col-span-2">
                        <h3 class="text-xl font-semibold mb-4">AI 智能預測 (KR Progress)</h3>
                        <div class="relative h-60">
                            <canvas id="chart-prediction"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">公司OKR達成率</h3>
                        <div class="relative h-60">
                            <canvas id="chart-overview"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">部門 OKR 達成率排名</h3>
                        <div class="relative h-60">
                            <canvas id="chart-dept-ranking"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6 col-span-2">
                        <h3 class="text-lg font-semibold mb-4">Alignment Heatmap</h3>
                        <div class="relative h-60">
                            <canvas id="chart-heatmap"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="login-section" class="absolute inset-0 flex items-center justify-center bg-gray-100">
        <div class="max-w-md w-full bg-white p-8 rounded shadow">
            <h2 class="text-2xl mb-6 text-center text-gray-800">OKR 戰情室登入</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-1">Email</label>
                    <input id="login-email" type="email" class="w-full p-2 border rounded" placeholder="電子郵件帳號" required />
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">密碼</label>
                    <input id="login-password" type="password" class="w-full p-2 border rounded" placeholder="輸入密碼" required />
                </div>
                <div class="text-red-500 text-sm" id="login-error"></div>
                <div class="pt-4">
                    <button type="submit" class="w-full bg-indigo-600 text-white p-2 rounded hover:bg-indigo-700">登入</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-30 hidden flex items-center justify-center z-50">
      <div id="modal-content" class="bg-white rounded-lg shadow-xl w-11/12 max-w-2xl p-6 space-y-4 overflow-y-auto max-h-[90vh] scrollbar-thin"></div>
    </div>

    <script>
        let sessionToken = '';
        let CURRENT_USER_EMAIL = '';
        let CURRENT_USER_DEPT = '';

        function showLogin() {
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('header').classList.add('hidden');
            document.getElementById('main-content').classList.add('hidden');
        }

        function showMainUI() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('header').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            
            const modalOverlay = document.getElementById('modal-overlay');
            if (modalOverlay && !modalOverlay.dataset.hasClickListener) {
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target === modalOverlay) hideModal();
                });
                modalOverlay.dataset.hasClickListener = 'true';
            }
        }

        function hideAllSections() {
            document.getElementById('section-company').classList.add('hidden');
            document.getElementById('section-dept').classList.add('hidden');
            document.getElementById('section-personal').classList.add('hidden');
            document.getElementById('section-approvals').classList.add('hidden');
            document.getElementById('section-mindmap').classList.add('hidden');
            document.getElementById('section-reports').classList.add('hidden');
        }

        function showSection(secElem) {
            hideAllSections();
            secElem.classList.remove('hidden');
        }

        function showModal(htmlContent) {
            const modalContentElem = document.getElementById('modal-content');
            const modalOverlayElem = document.getElementById('modal-overlay');
            if (!modalContentElem || !modalOverlayElem) {
                console.error("Modal elements not found. Cannot show modal.");
                return;
            }
            modalContentElem.innerHTML = htmlContent;
            modalOverlayElem.classList.remove('hidden');
            modalOverlayElem.classList.add('flex');
        }

        function hideModal() {
            const modalContentElem = document.getElementById('modal-content');
            const modalOverlayElem = document.getElementById('modal-overlay');
            if (!modalContentElem || !modalOverlayElem) {
                console.warn("Modal elements not found. Cannot hide modal.");
                return;
            }
            modalOverlayElem.classList.add('hidden');
            modalOverlayElem.classList.remove('flex');
            modalContentElem.innerHTML = '';
        }

        document.addEventListener('DOMContentLoaded', () => {
            showLogin();
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            document.getElementById('login-error').innerText = '';
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            if (!email) {
                document.getElementById('login-error').innerText = '請輸入 Email';
                return;
            }
            if (!password) {
                document.getElementById('login-error').innerText = '請輸入密碼';
                return;
            }
            google.script.run.withSuccessHandler(handleLogin).loginUser(email, password);
        });

        function handleLogin(res) {
            if (res.success) {
                sessionToken = res.sessionToken;
                CURRENT_USER_EMAIL = res.email;
                CURRENT_USER_DEPT = res.department || '';
                document.getElementById('user-email-display').innerText = 'Hello, ' + CURRENT_USER_EMAIL;
                showMainUI();
                document.getElementById('nav-company').click();
            } else {
                document.getElementById('login-error').innerText = res.message;
            }
        }

        document.getElementById('nav-company').addEventListener('click', () => {
            document.getElementById('nav-company').classList.replace('text-gray-700', 'text-indigo-600');
            document.getElementById('nav-dept').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-personal').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-approvals').classList.replace('text-yellow-700', 'text-gray-700');
            document.getElementById('nav-mindmap').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-reports').classList.replace('text-indigo-600', 'text-gray-700');
            showSection(document.getElementById('section-company'));
            loadCompanyObjectives();
        });
        document.getElementById('nav-dept').addEventListener('click', () => {
            document.getElementById('nav-dept').classList.replace('text-gray-700', 'text-indigo-600');
            document.getElementById('nav-company').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-personal').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-approvals').classList.replace('text-yellow-700', 'text-gray-700');
            document.getElementById('nav-mindmap').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-reports').classList.replace('text-indigo-600', 'text-gray-700');
            showSection(document.getElementById('section-dept'));
            loadDepartmentObjectives();
        });
        document.getElementById('nav-personal').addEventListener('click', () => {
            document.getElementById('nav-personal').classList.replace('text-gray-700', 'text-indigo-600');
            document.getElementById('nav-company').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-dept').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-approvals').classList.replace('text-yellow-700', 'text-gray-700');
            document.getElementById('nav-mindmap').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-reports').classList.replace('text-indigo-600', 'text-gray-700');
            showSection(document.getElementById('section-personal'));
            loadPersonalObjectives();
        });
        document.getElementById('nav-approvals').addEventListener('click', () => {
            document.getElementById('nav-approvals').classList.replace('text-gray-700', 'text-yellow-700');
            document.getElementById('nav-company').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-dept').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-personal').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-mindmap').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-reports').classList.replace('text-indigo-600', 'text-gray-700');
            showSection(document.getElementById('section-approvals'));
            loadApprovals();
        });
        document.getElementById('nav-mindmap').addEventListener('click', () => {
            document.getElementById('nav-mindmap').classList.replace('text-gray-700', 'text-indigo-600');
            document.getElementById('nav-company').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-dept').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-personal').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-approvals').classList.replace('text-yellow-700', 'text-gray-700');
            document.getElementById('nav-reports').classList.replace('text-indigo-600', 'text-gray-700');
            showSection(document.getElementById('section-mindmap'));
            loadMindmap();
        });
        document.getElementById('nav-reports').addEventListener('click', () => {
            document.getElementById('nav-reports').classList.replace('text-gray-700', 'text-indigo-600');
            document.getElementById('nav-company').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-dept').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-personal').classList.replace('text-indigo-600', 'text-gray-700');
            document.getElementById('nav-approvals').classList.replace('text-yellow-700', 'text-gray-700');
            document.getElementById('nav-mindmap').classList.replace('text-indigo-600', 'text-gray-700');
            showSection(document.getElementById('section-reports'));
            loadReports();
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            google.script.run.withSuccessHandler(() => location.reload()).logoutUser(sessionToken);
        });

        // 通用渲染 Objective 和 KR 列表 (新佈局)
        function renderObjectiveWithKRs(objective, krList, type) {
            let mainColor = 'indigo';
            if (type === 'dept') mainColor = 'blue';
            else if (type === 'personal') mainColor = 'green';

            const statusMap = {
                'Draft': '草稿', 'Pending': '待審核', 'Approved': '已批准', 'Rejected': '已駁回',
                'On Track': '良好', 'Off Track': '有風險', 'Completed': '已完成'
            };

            let html = `
                <div class="bg-white rounded-lg shadow p-4 mb-4">
                    <div class="flex items-center justify-between cursor-pointer objective-header" data-id="${objective.ID}" data-type="${type}">
                        <div class="flex-1">
                            <h3 class="text-xl font-semibold text-gray-800">${objective.ID}：${objective.Title}</h3>
                            ${objective.Description ? `<p class="text-gray-600 mt-1 text-sm">${objective.Description}</p>` : ''}
                            <p class="text-gray-600 mt-1">Owner: ${objective.OwnerEmail}</p>
                            ${objective.DepartmentID ? `<p class="text-gray-600 text-sm">Department: ${objective.DepartmentID}</p>` : ''}
                            ${objective.ParentCompanyKR ? `<p class="text-gray-600 text-sm">Parent Company KR: ${objective.ParentCompanyKR}</p>` : ''}
                            ${objective.ParentDepartmentKR ? `<p class="text-gray-600 text-sm">Parent Dept KR: ${objective.ParentDepartmentKR}</p>` : ''}
                        </div>
                        <div class="text-right flex items-center">
                            <span class="text-gray-500 text-sm mr-2">${objective.Progress}% 達成</span>
                            <div class="w-24 bg-gray-200 rounded-full h-2">
                                <div class="bg-${mainColor}-600 h-2 rounded-full" style="width: ${objective.Progress}%;"></div>
                            </div>
                            <span class="text-gray-500 text-sm ml-2">狀態: ${statusMap[objective.Status] || objective.Status}</span>
                            <svg class="w-6 h-6 ml-4 text-gray-500 collapse-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button data-id="${objective.ID}" class="btn-create-KR bg-${mainColor}-600 text-white px-3 py-1 rounded text-sm">新增 KR</button>
                            <button data-id="${objective.ID}" data-type="${type}" class="btn-edit-O bg-yellow-500 text-white px-3 py-1 rounded text-sm">編輯 O</button>
                            <button data-id="${objective.ID}" data-type="${type}" class="btn-delete-O bg-red-500 text-white px-3 py-1 rounded text-sm">刪除 O</button>
                            ${objective.OwnerEmail === CURRENT_USER_EMAIL && objective.Status === 'Draft'
                                ? `<button data-id="${objective.ID}" data-sheet="${type === 'company' ? 'Company_Objectives' : type === 'dept' ? 'Department_Objectives' : 'My_Objectives'}" class="btn-submit-O px-3 py-1 text-white bg-blue-500 rounded text-sm">送審</button>`
                                : ''}
                            <button data-id="${objective.ID}" class="btn-comments-O bg-gray-100 text-gray-700 px-3 py-1 rounded text-sm">留言</button>
                        </div>
                    </div>

                    <div class="kr-list-container space-y-2 mt-4 pl-4 hidden">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">關鍵結果 (Key Results):</h4>
            `;

            if (krList.length === 0) {
                html += `<p class="text-gray-500 text-sm ml-2">此 Objective 尚無支撐 Key Result。</p>`;
            } else {
                krList.forEach(kr => {
                    let krProgressBarColor = mainColor;
                    if (kr.ID.startsWith('C-')) krProgressBarColor = 'indigo';
                    else if (kr.ID.startsWith('D-')) krProgressBarColor = 'blue';
                    else if (kr.ID.startsWith('P-')) krProgressBarColor = 'green';
                    
                    html += `
                        <div class="bg-white rounded p-3 border border-gray-200 flex flex-col mb-2">
                            <div class="flex items-center justify-between">
                                <p class="font-medium text-gray-800 flex-1">${kr.ID}：${kr.Description}</p>
                                <div class="text-right">
                                    <p class="text-gray-600 text-sm">當前: ${kr.CurrentValue || 0}/${kr.TargetValue || 0} ${kr.Unit || ''}</p>
                                    <p class="text-gray-500 text-xs">狀態: ${statusMap[kr.Status] || kr.Status}</p>
                                </div>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div class="bg-${krProgressBarColor}-600 h-2 rounded-full" style="width: ${kr.Progress || 0}%;"></div>
                            </div>
                            <p class="text-right text-gray-500 text-sm mt-1">${kr.Progress || 0}%</p>
                            <div class="flex justify-end space-x-2 mt-2">
                                <button data-id="${kr.ID}" class="btn-edit-KR bg-yellow-400 text-white px-2 py-1 rounded text-xs">更新</button>
                                <button data-id="${kr.ID}" class="btn-detail-KR bg-gray-200 text-gray-700 px-2 py-1 rounded text-xs">詳情</button>
                            </div>
                        </div>
                    `;
                });
            }
            html += `</div></div>`;
            return html;
        }

        // 7. 載入公司級 Objectives (調整以獲取所有 KR)
        function loadCompanyObjectives(filter = '') {
            const companyListElem = document.getElementById('company-list');
            if (!companyListElem) { console.error("Element #company-list not found."); return; }
            companyListElem.innerHTML = '<p class="text-gray-500">載入中...</p>';
            google.script.run.withSuccessHandler(objResStr => {
                const objRes = JSON.parse(objResStr);
                if (objRes.error) {
                    companyListElem.innerHTML = `<p class="text-red-500">${objRes.error}</p>`;
                    return;
                }
                let objectives = objRes.objectives;
                if (filter) {
                    const kw = filter.toLowerCase();
                    objectives = objectives.filter(o => o.Title.toLowerCase().includes(kw) || o.OwnerEmail.toLowerCase().includes(kw));
                }
                if (!objectives.length) {
                    companyListElem.innerHTML = '<p class="text-gray-500">目前沒有任何公司級目標。</p>';
                    return;
                }

                google.script.run.withSuccessHandler(krResStr => {
                    const krRes = JSON.parse(krResStr);
                    if (krRes.error) {
                        companyListElem.innerHTML = `<p class="text-red-500">載入 Key Results 失敗: ${krRes.error}</p>`;
                        return;
                    }
                    const allKRs = krRes.keyResults;
                    companyListElem.innerHTML = '';

                    objectives.forEach(obj => {
                        const objKRs = allKRs.filter(kr => kr.ObjectiveID === obj.ID);
                        const objHtml = renderObjectiveWithKRs(obj, objKRs, 'company');
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = objHtml;
                        companyListElem.appendChild(tempDiv.firstElementChild);
                    });

                }).getKeyResultsByObjective(sessionToken, '__ALL_COMPANY__');
            }).getCompanyObjectives(sessionToken);
        }

        document.getElementById('search-company').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('btn-filter-company').click();
            }
        });

        // 8. 新增公司級 Objective Modal
        function openCreateCompanyModal() {
            const html = `
                <h3 class="text-xl font-semibold mb-4">新增公司級 Objective</h3>
                <form id="form-create-company" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-1">標題</label>
                        <input id="company-title" type="text" class="w-full p-2 border rounded" placeholder="公司級 O 標題" required />
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">描述</label>
                        <textarea id="company-desc" class="w-full p-2 border rounded" rows="3" placeholder="公司級 O 描述"></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">負責人 Email</label>
                        <input id="company-owner" type="email" class="w-full p-2 border rounded" value="${CURRENT_USER_EMAIL}" required />
                    </div>
                    <div class="flex justify-end space-x-2 pt-4 border-t mt-4">
                        <button type="button" id="btn-cancel-company" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">取消</button>
                        <button type="submit" id="btn-submit-company" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">提交</button>
                    </div>
                </form>
            `;
            showModal(html);
            document.getElementById('btn-cancel-company').addEventListener('click', hideModal);
            document.getElementById('form-create-company').addEventListener('submit', (e) => {
                e.preventDefault();
                const data = {
                    Title: document.getElementById('company-title').value.trim(),
                    Description: document.getElementById('company-desc').value.trim(),
                    OwnerEmail: document.getElementById('company-owner').value.trim()
                };
                google.script.run.withSuccessHandler(res => {
                    alert(res.message);
                    hideModal();
                    loadCompanyObjectives(document.getElementById('search-company').value.trim());
                }).createCompanyObjective(sessionToken, data);
            });
        }

        // 9. 編輯公司級 Objective Modal
        function openEditCompanyOModal(companyOId) {
            google.script.run.withSuccessHandler(resStr => {
                const res = JSON.parse(resStr);
                if (res.error) {
                    alert(res.error);
                    return;
                }
                const obj = res.objectives.find(x => x.ID === companyOId);
                if (!obj) {
                    alert('找不到該 O');
                    return;
                }
                const html = `
                    <h3 class="text-xl font-semibold mb-4">編輯 公司級 O ${obj.ID}</h3>
                    <form id="form-edit-company" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-1">O ID</label>
                            <input id="edit-company-id" type="text" value="${obj.ID}" class="w-full p-2 border rounded bg-gray-100" readonly />
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">標題</label>
                            <input id="edit-company-title" type="text" value="${obj.Title}" class="w-full p-2 border rounded" required />
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">描述</label>
                            <textarea id="edit-company-desc" class="w-full p-2 border rounded" rows="3">${obj.Description}</textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">負責人 Email</label>
                            <input id="edit-company-owner" type="email" value="${obj.OwnerEmail}" class="w-full p-2 border rounded" required />
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Status</label>
                            <select id="edit-company-status" class="w-full p-2 border rounded">
                                <option value="Draft" ${obj.Status === 'Draft' ? 'selected' : ''}>Draft</option>
                                <option value="Pending" ${obj.Status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Approved" ${obj.Status === 'Approved' ? 'selected' : ''}>Approved</option>
                                <option value="Rejected" ${obj.Status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Approver Email</label>
                            <input id="edit-company-approver" type="email" value="${obj.ApproverEmail || ''}" class="w-full p-2 border rounded" />
                        </div>
                        <div class="flex justify-end space-x-2 pt-4 border-t mt-4">
                            <button type="button" id="btn-cancel-edit-company" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">取消</button>
                            <button type="submit" id="btn-submit-edit-company" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">更新</button>
                        </div>
                    </form>
                `;
                showModal(html);
                document.getElementById('btn-cancel-edit-company').addEventListener('click', hideModal);
                document.getElementById('form-edit-company').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const data = {
                        ID: obj.ID,
                        Title: document.getElementById('edit-company-title').value.trim(),
                        Description: document.getElementById('edit-company-desc').value.trim(),
                        OwnerEmail: document.getElementById('edit-company-owner').value.trim(),
                        Status: document.getElementById('edit-company-status').value,
                        ApproverEmail: document.getElementById('edit-company-approver').value.trim()
                    };
                    google.script.run.withSuccessHandler(res => {
                        alert(res.message);
                        hideModal();
                        loadCompanyObjectives(document.getElementById('search-company').value.trim());
                    }).updateCompanyObjective(sessionToken, data);
                });
            }).getCompanyObjectives(sessionToken);
        }

        // 11. 顯示公司 O 的 KR 列表 Modal (已移除，功能合併到主列表)
        function showCompanyOKRListModal(companyOId) {
            alert('此功能已併入主列表，點擊目標標題可展開/收合關鍵結果。');
            console.log(`Company O ${companyOId} KRs are shown directly in the list.`);
        }

        // 12. 新增公司 KR Modal
        function openCreateCompanyKRModal(companyOId) {
            const html = `
                <h3 class="text-xl font-semibold mb-4">新增公司級 Key Result</h3>
                <form id="form-create-company-KR" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-1">Parent Objective ID</label>
                        <input id="kr-parent-company-O" type="text" value="${companyOId}" class="w-full p-2 border rounded bg-gray-100" readonly />
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">KR 描述</label>
                        <input id="kr-desc" type="text" class="w-full p-2 border rounded" placeholder="KR 描述" required />
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">負責人 Email</label>
                        <input id="kr-owner" type="email" value="${CURRENT_USER_EMAIL}" class="w-full p-2 border rounded" required />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 mb-1">起始值</label>
                            <input id="kr-start" type="number" class="w-full p-2 border rounded" value="0" required />
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">目標值</label>
                            <input id="kr-target" type="number" class="w-full p-2 border rounded" value="100" required />
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">單位</label>
                        <input id="kr-unit" type="text" class="w-full p-2 border rounded" placeholder="例如：%" />
                    </div>
                    <div class="flex justify-end space-x-2 pt-4 border-t mt-4">
                        <button type="button" id="btn-cancel-company-kr" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">取消</button>
                        <button type="submit" id="btn-submit-company-kr" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">提交</button>
                    </div>
                </form>
            `;
            showModal(html);
            setTimeout(() => {
                document.getElementById('btn-cancel-company-kr')?.addEventListener('click', hideModal);
                document.getElementById('form-create-company-KR')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const data = {
                        ObjectiveID: document.getElementById('kr-parent-company-O').value,
                        Description: document.getElementById('kr-desc').value.trim(),
                        OwnerEmail: document.getElementById('kr-owner').value.trim(),
                        StartValue: Number(document.getElementById('kr-start').value),
                        TargetValue: Number(document.getElementById('kr-target').value),
                        Unit: document.getElementById('kr-unit').value.trim()
                    };
                    google.script.run.withSuccessHandler(res => {
                        alert(res.message);
                        hideModal();
                        loadCompanyObjectives(document.getElementById('search-company').value.trim());
                    }).createKeyResult(sessionToken, data);
                });
            }, 0);
        }

        // 13. 編輯 KR Modal (通用化)
        function openEditKRModal(krId) {
            google.script.run.withSuccessHandler(resStr => {
                const res = JSON.parse(resStr);
                let kr = res.keyResults.find(x => x.ID === krId);

                if (!kr) {
                    alert('找不到該 KR');
                    return;
                }

                const html = `
                    <h3 class="text-xl font-semibold mb-4">更新 Key Result ${kr.ID}</h3>
                    <form id="form-edit-kr" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-1">KR ID</label>
                            <input id="edit-kr-id" type="text" class="w-full p-2 border rounded bg-gray-100" readonly />
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">KR 描述</label>
                            <input id="edit-kr-desc" type="text" class="w-full p-2 border rounded" required />
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">負責人 Email</label>
                            <input id="edit-kr-owner" type="email" class="w-full p-2 border rounded" required />
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 mb-1">起始值</label>
                                <input id="edit-kr-start" type="number" class="w-full p-2 border rounded" required />
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">目標值</label>
                                <input id="edit-kr-target" type="number" class="w-full p-2 border rounded" required />
                            </div>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">目前值</label>
                            <input id="edit-kr-current" type="number" class="w-full p-2 border rounded" required />
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">進度 (%)</label>
                            <input id="edit-kr-progress" type="number" class="w-full p-2 border rounded" required />
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">單位</label>
                            <input id="edit-kr-unit" type="text" class="w-full p-2 border rounded" />
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Status</label>
                            <select id="edit-kr-status" class="w-full p-2 border rounded">
                                <option value="On Track" ${kr.Status === 'On Track' ? 'selected' : ''}>On Track</option>
                                <option value="Off Track" ${kr.Status === 'Off Track' ? 'selected' : ''}>Off Track</option>
                                <option value="Completed" ${kr.Status === 'Completed' ? 'selected' : ''}>Completed</option>
                            </select>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4 border-t mt-4">
                            <button type="button" id="btn-cancel-edit-kr" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">取消</button>
                            <button type="button" id="btn-delete-kr-from-modal" data-id="${kr.ID}" data-objective-id="${kr.ObjectiveID}" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">刪除 KR</button>
                            <button type="submit" id="btn-submit-edit-kr" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">更新 KR</button>
                        </div>
                    </form>
                `;
                showModal(html);

                setTimeout(() => {
                    const editKrId = document.getElementById('edit-kr-id');
                    const editKrDesc = document.getElementById('edit-kr-desc');
                    const editKrOwner = document.getElementById('edit-kr-owner');
                    const editKrStart = document.getElementById('edit-kr-start');
                    const editKrTarget = document.getElementById('edit-kr-target');
                    const editKrCurrent = document.getElementById('edit-kr-current');
                    const editKrProgress = document.getElementById('edit-kr-progress');
                    const editKrUnit = document.getElementById('edit-kr-unit');
                    const editKrStatus = document.getElementById('edit-kr-status');
                    const btnCancel = document.getElementById('btn-cancel-edit-kr');
                    const formEditKr = document.getElementById('form-edit-kr');
                    
                    if (!editKrId || !editKrDesc || !editKrOwner || !editKrStart || !editKrTarget || !editKrCurrent || !editKrProgress || !editKrUnit || !editKrStatus || !btnCancel || !formEditKr) {
                        console.error("Modal elements not found after setTimeout. Re-check IDs or rendering.");
                        alert("載入 KR 編輯表單失敗，請重試。");
                        hideModal();
                        return;
                    }

                    editKrId.value = kr.ID;
                    editKrDesc.value = kr.Description;
                    editKrOwner.value = kr.OwnerEmail;
                    editKrStart.value = kr.StartValue;
                    editKrTarget.value = kr.TargetValue;
                    editKrCurrent.value = kr.CurrentValue;
                    editKrProgress.value = kr.Progress;
                    editKrUnit.value = kr.Unit;
                    const options = Array.from(editKrStatus.options);
                    options.forEach(option => {
                        if (option.value === kr.Status) {
                            option.selected = true;
                        } else {
                            option.selected = false;
                        }
                    });

                    btnCancel.addEventListener('click', hideModal);
                    formEditKr.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const data = {
                            ID: editKrId.value,
                            Description: editKrDesc.value.trim(),
                            OwnerEmail: editKrOwner.value.trim(),
                            StartValue: Number(editKrStart.value),
                            TargetValue: Number(editKrTarget.value),
                            CurrentValue: Number(editKrCurrent.value),
                            Progress: Number(editKrProgress.value),
                            Unit: editKrUnit.value.trim(),
                            Status: editKrStatus.value
                        };
                        google.script.run.withSuccessHandler(resSubmit => {
                            alert(resSubmit.message);
                            hideModal();
                            if (kr.ObjectiveID.startsWith('C-')) loadCompanyObjectives(document.getElementById('search-company').value.trim());
                            else if (kr.ObjectiveID.startsWith('D-')) loadDepartmentObjectives(document.getElementById('search-dept').value.trim());
                            else if (kr.ObjectiveID.startsWith('P-')) loadPersonalObjectives(document.getElementById('search-personal').value.trim());
                        }).updateKeyResult(sessionToken, data);
                    });
                }, 0);
            }).getKeyResultsByObjective(sessionToken, '__ALL_COMPANY__');
        }

        // 14. 刪除 KR (從編輯 Modal 內觸發)
        // Handled by global event listener on btn-delete-kr-from-modal

        // 15. 載入部門級 Objectives
        function loadDepartmentObjectives(filter = '') {
            const deptListElem = document.getElementById('dept-list');
            if (!deptListElem) { console.error("Element #dept-list not found."); return; }
            deptListElem.innerHTML = '<p class="text-gray-500">載入中...</p>';
            google.script.run.withSuccessHandler(objResStr => {
                const objRes = JSON.parse(objResStr);
                if (objRes.error) {
                    deptListElem.innerHTML = `<p class="text-red-500">${objRes.error}</p>`;
                    return;
                }
                let objectives = objRes.objectives;
                if (filter) {
                    const kw = filter.toLowerCase();
                    objectives = objectives.filter(o =>
                        o.Title.toLowerCase().includes(kw) ||
                        o.OwnerEmail.toLowerCase().includes(kw) ||
                        o.DepartmentID.toLowerCase().includes(kw)
                    );
                }
                if (!objectives.length) {
                    deptListElem.innerHTML = '<p class="text-gray-500">目前沒有任何部門級目標。</p>';
                    return;
                }

                google.script.run.withSuccessHandler(krResStr => {
                    const krRes = JSON.parse(krResStr);
                    if (krRes.error) {
                        deptListElem.innerHTML = `<p class="text-red-500">載入 Key Results 失敗: ${krRes.error}</p>`;
                        return;
                    }
                    const allKRs = krRes.keyResults;
                    deptListElem.innerHTML = '';

                    objectives.forEach(obj => {
                        const objKRs = allKRs.filter(kr => kr.ObjectiveID === obj.ID);
                        const objHtml = renderObjectiveWithKRs(obj, objKRs, 'dept');
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = objHtml;
                        deptListElem.appendChild(tempDiv.firstElementChild);
                    });

                }).getKeyResultsByObjective(sessionToken, '__ALL_DEPT__');
            }).getDepartmentObjectives(sessionToken);
        }

        document.getElementById('search-dept').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('btn-filter-dept').click();
            }
        });

        // 16. 新增部門級 Objective Modal
        function openCreateDeptModal() {
            google.script.run.withSuccessHandler(res => {
                const r = JSON.parse(res);
                let options = r.parentCompanyKRs.map(k => `<option value="${k.ID}">${k.ID}：${k.Description}</option>`).join('');
                const html = `
                    <h3 class="text-xl font-semibold mb-4">新增部門級 Objective</h3>
                    <form id="form-create-dept" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-1">Parent Company KR</label>
                            <select id="dept-parent-kr" class="w-full p-2 border rounded" required>
                                <option value="">請選擇</option>
                                ${options}
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">標題</label>
                            <input id="dept-title" type="text" class="w-full p-2 border rounded" placeholder="部門級 O 標題" required />
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">描述</label>
                            <textarea id="dept-desc" class="w-full p-2 border rounded" rows="3" placeholder="部門級 O 描述"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">負責人 Email</label>
                            <input id="dept-owner" type="email" value="${CURRENT_USER_EMAIL}" class="w-full p-2 border rounded" required />
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Department ID</label>
                            <input id="dept-id" type="text" value="${CURRENT_USER_DEPT}" class="w-full p-2 border rounded bg-gray-100" readonly />
                        </div>
                        <div class="flex justify-end space-x-2 pt-4 border-t mt-4">
                            <button type="button" id="btn-cancel-dept" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">取消</button>
                            <button type="submit" id="btn-submit-dept" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">提交</button>
                        </div>
                    </form>
                `;
                showModal(html);
                document.getElementById('btn-cancel-dept').addEventListener('click', hideModal);
                document.getElementById('form-create-dept').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const data = {
                        Title: document.getElementById('dept-title').value.trim(),
                        Description: document.getElementById('dept-desc').value.trim(),
                        OwnerEmail: document.getElementById('dept-owner').value.trim(),
                        DepartmentID: document.getElementById('dept-id').value.trim(),
                        ParentCompanyKR: document.getElementById('dept-parent-kr').value
                    };
                    google.script.run.withSuccessHandler(res => {
                        alert(res.message);
                        hideModal();
                        loadDepartmentObjectives(document.getElementById('search-dept').value.trim());
                    }).createDepartmentObjective(sessionToken, data);
                });
            }).getAllCompanyKRs(sessionToken);
        }

        // 17. 編輯部門級 Objective Modal
        function openEditDeptOModal(deptOId) {
            google.script.run.withSuccessHandler(resStr => {
                const res = JSON.parse(resStr);
                if (res.error) {
                    alert(res.error);
                    return;
                }
                const obj = res.objectives.find(x => x.ID === deptOId);
                if (!obj) {
                    alert('找不到該部門 O');
                    return;
                }
                google.script.run.withSuccessHandler(resKRStr => {
                    const resKR = JSON.parse(resKRStr);
                    let options = resKR.parentCompanyKRs.map(k =>
                        `<option value="${k.ID}" ${k.ID === obj.ParentCompanyKR ? 'selected' : ''}>${k.ID}：${k.Description}</option>`
                    ).join('');
                    const html = `
                        <h3 class="text-xl font-semibold mb-4">編輯 部門級 O ${obj.ID}</h3>
                        <form id="form-edit-dept" class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-1">O ID</label>
                                <input id="edit-dept-id" type="text" value="${obj.ID}" class="w-full p-2 border rounded bg-gray-100" readonly />
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">Parent Company KR</label>
                                <select id="edit-dept-parent-kr" class="w-full p-2 border rounded" required>
                                    <option value="">請選擇</option>
                                    ${options}
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">標題</label>
                                <input id="edit-dept-title" type="text" class="w-full p-2 border rounded" required />
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">描述</label>
                                <textarea id="edit-dept-desc" class="w-full p-2 border rounded" rows="3">${obj.Description}</textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">負責人 Email</label>
                                <input id="edit-dept-owner" type="email" value="${obj.OwnerEmail}" class="w-full p-2 border rounded" required />
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">Status</label>
                                <select id="edit-dept-status" class="w-full p-2 border rounded">
                                    <option value="Draft" ${obj.Status === 'Draft' ? 'selected' : ''}>Draft</option>
                                    <option value="Pending" ${obj.Status === 'Pending' ? 'selected' : ''}>Pending</option>
                                    <option value="Approved" ${obj.Status === 'Approved' ? 'selected' : ''}>Approved</option>
                                    <option value="Rejected" ${obj.Status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">Approver Email</label>
                                <input id="edit-dept-approver" type="email" value="${obj.ApproverEmail || ''}" class="w-full p-2 border rounded" />
                            </div>
                            <div class="flex justify-end space-x-2 pt-4 border-t mt-4">
                                <button type="button" id="btn-cancel-edit-dept" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">取消</button>
                                <button type="submit" id="btn-submit-edit-dept" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">更新</button>
                            </div>
                        </form>
                    `;
                    showModal(html);
                    document.getElementById('btn-cancel-edit-dept').addEventListener('click', hideModal);
                    document.getElementById('form-edit-dept').addEventListener('submit', (e) => {
                        e.preventDefault();
                        const data = {
                            ID: obj.ID,
                            Title: document.getElementById('edit-dept-title').value.trim(),
                            Description: document.getElementById('edit-dept-desc').value.trim(),
                            OwnerEmail: document.getElementById('edit-dept-owner').value.trim(),
                            Status: document.getElementById('edit-dept-status').value,
                            ApproverEmail: document.getElementById('edit-dept-approver').value.trim(),
                            ParentCompanyKR: document.getElementById('edit-dept-parent-kr').value
                        };
                        google.script.run.withSuccessHandler(res => {
                            alert(res.message);
                            hideModal();
                            loadDepartmentObjectives(document.getElementById('search-dept').value.trim());
                        }).updateDepartmentObjective(sessionToken, data);
                    });
                }).getAllCompanyKRs(sessionToken);
            }).getDepartmentObjectives(sessionToken);
        }

        // 19. 顯示部門 O 的 KR 列表 Modal 
        function showDeptOKRListModal(deptOId) {
            alert('此功能已併入主列表，點擊目標標題可展開/收合關鍵結果。');
            console.log(`Department O ${deptOId} KRs are shown directly in the list.`);
        }

        // 20. 新增部門 KR Modal
        function openCreateDeptKRModal(deptOId) {
            const html = `
                <h3 class="text-xl font-semibold mb-4">新增部門 KR</h3>
                <form id="form-create-dept-KR" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-1">Parent Department O ID</label>
                        <input id="kr-parent-dept-O" type="text" value="${deptOId}" class="w-full p-2 border rounded bg-gray-100" readonly />
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">KR 描述</label>
                        <input id="kr-desc" type="text" class="w-full p-2 border rounded" placeholder="KR 描述" required />
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">負責人 Email</label>
                        <input id="kr-owner" type="email" value="${CURRENT_USER_EMAIL}" class="w-full p-2 border rounded" required />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 mb-1">起始值</label>
                            <input id="kr-start" type="number" class="w-full p-2 border rounded" value="0" required />
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">目標值</label>
                            <input id="kr-target" type="number" class="w-full p-2 border rounded" value="100" required />
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">單位</label>
                        <input id="kr-unit" type="text" class="w-full p-2 border rounded" placeholder="例如：%" />
                    </div>
                    <div class="flex justify-end space-x-2 pt-4 border-t mt-4">
                        <button type="button" id="btn-cancel-dept-kr" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">取消</button>
                        <button type="submit" id="btn-submit-dept-kr" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">提交</button>
                    </div>
                </form>
            `;
            showModal(html);
            document.getElementById('btn-cancel-dept-kr').addEventListener('click', hideModal);
            document.getElementById('form-create-dept-KR').addEventListener('submit', (e) => {
                e.preventDefault();
                const data = {
                    ObjectiveID: document.getElementById('kr-parent-dept-O').value,
                    Description: document.getElementById('kr-desc').value.trim(),
                    OwnerEmail: document.getElementById('kr-owner').value.trim(),
                    StartValue: Number(document.getElementById('kr-start').value),
                    TargetValue: Number(document.getElementById('kr-target').value),
                    Unit: document.getElementById('kr-unit').value.trim()
                };
                google.script.run.withSuccessHandler(res => {
                    alert(res.message);
                    hideModal();
                    loadDepartmentObjectives(document.getElementById('search-dept').value.trim());
                }).createKeyResult(sessionToken, data);
            });
        }

        // 21. 編輯部門 KR Modal (已通用化到 openEditKRModal)
        function openEditDeptKRModal(krId) {
            openEditKRModal(krId);
        }

        // 22. 刪除部門 KR (已收斂到 openEditKRModal)
        // Handled by global event listener on btn-delete-kr-from-modal

        // 23. 載入我的 Objectives
        function loadPersonalObjectives(filter = '') {
            const personalListElem = document.getElementById('personal-list');
            if (!personalListElem) { console.error("Element #personal-list not found."); return; }
            personalListElem.innerHTML = '<p class="text-gray-500">載入中...</p>';
            google.script.run.withSuccessHandler(objResStr => {
                const objRes = JSON.parse(objResStr);
                if (objRes.error) {
                    personalListElem.innerHTML = `<p class="text-red-500">${objRes.error}</p>`;
                    return;
                }
                let objectives = objRes.objectives;
                if (filter) {
                    const kw = filter.toLowerCase();
                    objectives = objectives.filter(o =>
                        o.Title.toLowerCase().includes(kw) || o.OwnerEmail.toLowerCase().includes(kw)
                    );
                }
                if (!objectives.length) {
                    personalListElem.innerHTML = '<p class="text-gray-500">目前沒有任何個人級目標。</p>';
                    return;
                }

                google.script.run.withSuccessHandler(krResStr => {
                    const krRes = JSON.parse(krResStr);
                    if (krRes.error) {
                        personalListElem.innerHTML = `<p class="text-red-500">載入 Key Results 失敗: ${krRes.error}</p>`;
                        return;
                    }
                    const allKRs = krRes.keyResults;
                    personalListElem.innerHTML = '';

                    objectives.forEach(obj => {
                        const objKRs = allKRs.filter(kr => kr.ObjectiveID === obj.ID);
                        const objHtml = renderObjectiveWithKRs(obj, objKRs, 'personal');
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = objHtml;
                        personalListElem.appendChild(tempDiv.firstElementChild);
                    });

                }).getKeyResultsByObjective(sessionToken, '__ALL_PERSONAL__');
            }).getMyObjectives(sessionToken);
        }

        document.getElementById('search-personal').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('btn-filter-personal').click();
            }
        });

        // 24. 新增個人級 Objective Modal
        function openCreatePersonalOModal() {
            google.script.run.withSuccessHandler(res => {
                const r = JSON.parse(res);
                let options = r.parentDeptKRs.map(k => `<option value="${k.ID}">${k.ID}：${k.Description}</option>`).join('');
                const html = `
                    <h3 class="text-xl font-semibold mb-4">新增個人級 Objective</h3>
                    <form id="form-create-personal" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-1">Parent Department KR</label>
                            <select id="personal-parent-kr" class="w-full p-2 border rounded" required>
                                <option value="">請選擇</option>
                                ${options}
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">標題</label>
                            <input id="personal-title" type="text" class="w-full p-2 border rounded" placeholder="個人級 O 標題" required />
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">描述</label>
                            <textarea id="personal-desc" class="w-full p-2 border rounded" rows="3" placeholder="個人級 O 描述"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">負責人 Email</label>
                            <input id="personal-owner" type="email" value="${CURRENT_USER_EMAIL}" class="w-full p-2 border rounded" required />
                        </div>
                        <div class="flex justify-end space-x-2 pt-4 border-t mt-4">
                            <button type="button" id="btn-cancel-personal" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">取消</button>
                            <button type="submit" id="btn-submit-personal" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">提交</button>
                        </div>
                    </form>
                `;
                showModal(html);
                document.getElementById('btn-cancel-personal').addEventListener('click', hideModal);
                document.getElementById('form-create-personal').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const data = {
                        Title: document.getElementById('personal-title').value.trim(),
                        Description: document.getElementById('personal-desc').value.trim(),
                        OwnerEmail: document.getElementById('personal-owner').value.trim(),
                        ParentDepartmentKR: document.getElementById('personal-parent-kr').value
                    };
                    google.script.run.withSuccessHandler(res => {
                        alert(res.message);
                        hideModal();
                        loadPersonalObjectives(document.getElementById('search-personal').value.trim());
                    }).createMyObjective(sessionToken, data);
                });
            }).getAllDepartmentKRs(sessionToken);
        }

        // 25. 編輯個人級 Objective Modal
        function openEditPersonalOModal(personalOId) {
            google.script.run.withSuccessHandler(resStr => {
                const res = JSON.parse(resStr);
                if (res.error) {
                    alert(res.error);
                    return;
                }
                const obj = res.objectives.find(x => x.ID === personalOId);
                if (!obj) {
                    alert('找不到該個人 O');
                    return;
                }
                google.script.run.withSuccessHandler(resKRStr => {
                    const resKR = JSON.parse(resKRStr);
                    let options = resKR.parentDeptKRs.map(k =>
                        `<option value="${k.ID}" ${k.ID === obj.ParentDepartmentKR ? 'selected' : ''}>${k.ID}：${k.Description}</option>`
                    ).join('');
                    const html = `
                        <h3 class="text-xl font-semibold mb-4">編輯 個人級 O ${obj.ID}</h3>
                        <form id="form-edit-personal" class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-1">O ID</label>
                                <input id="edit-personal-id" type="text" value="${obj.ID}" class="w-full p-2 border rounded bg-gray-100" readonly />
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">Parent Department KR</label>
                                <select id="edit-personal-parent-kr" class="w-full p-2 border rounded" required>
                                    <option value="">請選擇</option>
                                    ${options}
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">標題</label>
                                <input id="edit-personal-title" type="text" class="w-full p-2 border rounded" required />
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">描述</label>
                                <textarea id="edit-personal-desc" class="w-full p-2 border rounded" rows="3">${obj.Description}</textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">負責人 Email</label>
                                <input id="edit-personal-owner" type="email" value="${obj.OwnerEmail}" class="w-full p-2 border rounded" required />
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">Status</label>
                                <select id="edit-personal-status" class="w-full p-2 border rounded">
                                    <option value="Draft" ${obj.Status === 'Draft' ? 'selected' : ''}>Draft</option>
                                    <option value="Pending" ${obj.Status === 'Pending' ? 'selected' : ''}>Pending</option>
                                    <option value="Approved" ${obj.Status === 'Approved' ? 'selected' : ''}>Approved</option>
                                    <option value="Rejected" ${obj.Status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">Approver Email</label>
                                <input id="edit-personal-approver" type="email" value="${obj.ApproverEmail || ''}" class="w-full p-2 border rounded" />
                            </div>
                            <div class="flex justify-end space-x-2 pt-4 border-t mt-4">
                                <button type="button" id="btn-cancel-edit-personal" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">取消</button>
                                <button type="submit" id="btn-submit-edit-personal" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">更新</button>
                            </div>
                        </form>
                    `;
                    showModal(html);
                    document.getElementById('btn-cancel-edit-personal').addEventListener('click', hideModal);
                    document.getElementById('form-edit-personal').addEventListener('submit', (e) => {
                        e.preventDefault();
                        const data = {
                            ID: obj.ID,
                            Title: document.getElementById('edit-personal-title').value.trim(),
                            Description: document.getElementById('edit-personal-desc').value.trim(),
                            OwnerEmail: document.getElementById('edit-personal-owner').value.trim(),
                            Status: document.getElementById('edit-personal-status').value,
                            ApproverEmail: document.getElementById('edit-personal-approver').value.trim(),
                            ParentDepartmentKR: document.getElementById('edit-personal-parent-kr').value
                        };
                        google.script.run.withSuccessHandler(res => {
                            alert(res.message);
                            hideModal();
                            loadPersonalObjectives(document.getElementById('search-personal').value.trim());
                        }).updateMyObjective(sessionToken, data);
                    });
                }).getAllDepartmentKRs(sessionToken);
            }).getMyObjectives(sessionToken);
        }

        // 27. 顯示個人 O 的 KR 列表 Modal (已移除，功能合併到主列表)
        function showPersonalOKRListModal(personalOId) {
            alert('此功能已併入主列表，點擊目標標題可展開/收合關鍵結果。');
            console.log(`Personal O ${personalOId} KRs are shown directly in the list.`);
        }

        // 28. 新增個人 KR Modal
        function openCreatePersonalKRModal(personalOId) {
            const html = `
                <h3 class="text-xl font-semibold mb-4">新增個人 KR</h3>
                <form id="form-create-personal-KR" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-1">Parent Personal O ID</label>
                        <input id="kr-parent-personal-O" type="text" value="${personalOId}" class="w-full p-2 border rounded bg-gray-100" readonly />
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">KR 描述</label>
                        <input id="kr-desc" type="text" class="w-full p-2 border rounded" placeholder="KR 描述" required />
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">負責人 Email</label>
                        <input id="kr-owner" type="email" value="${CURRENT_USER_EMAIL}" class="w-full p-2 border rounded" required />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 mb-1">起始值</label>
                            <input id="kr-start" type="number" class="w-full p-2 border rounded" value="0" required />
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">目標值</label>
                            <input id="kr-target" type="number" class="w-full p-2 border rounded" value="100" required />
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">單位</label>
                        <input id="kr-unit" type="text" class="w-full p-2 border rounded" placeholder="例如：%" />
                    </div>
                    <div class="flex justify-end space-x-2 pt-4 border-t mt-4">
                        <button type="button" id="btn-cancel-personal-kr" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">取消</button>
                        <button type="submit" id="btn-submit-personal-kr" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">提交</button>
                    </div>
                </form>
            `;
            showModal(html);
            document.getElementById('btn-cancel-personal-kr').addEventListener('click', hideModal);
            document.getElementById('form-create-personal-KR').addEventListener('submit', (e) => {
                e.preventDefault();
                const data = {
                    ObjectiveID: document.getElementById('kr-parent-personal-O').value,
                    Description: document.getElementById('kr-desc').value.trim(),
                    OwnerEmail: document.getElementById('kr-owner').value.trim(),
                    StartValue: Number(document.getElementById('kr-start').value),
                    TargetValue: Number(document.getElementById('kr-target').value),
                    Unit: document.getElementById('kr-unit').value.trim()
                };
                google.script.run.withSuccessHandler(res => {
                    alert(res.message);
                    hideModal();
                    loadPersonalObjectives(document.getElementById('search-personal').value.trim());
                }).createKeyResult(sessionToken, data);
            });
        }

        // 29. 編輯個人 KR Modal (已通用化到 openEditKRModal)
        function openEditPersonalKRModal(krId) {
            openEditKRModal(krId);
        }

        // 30. 刪除個人 KR (已收斂到 openEditKRModal)
        // Handled by global event listener on btn-delete-kr-from-modal

        // 31. 載入審核中心
        function loadApprovals() {
            const approvalsListElem = document.getElementById('approvals-list');
            if (!approvalsListElem) { console.error("Element #approvals-list not found."); return; }
            approvalsListElem.innerHTML = '<p class="text-gray-500">載入中...</p>';
            google.script.run.withSuccessHandler(resStr => {
                const res = JSON.parse(resStr);
                if (res.error) {
                    approvalsListElem.innerHTML = `<p class="text-red-500">${res.error}</p>`;
                    return;
                }
                const list = res.pending;
                if (!list.length) {
                    approvalsListElem.innerHTML = '<p class="text-gray-500">目前沒有待審核項目。</p>';
                    return;
                }
                approvalsListElem.innerHTML = '';
                list.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow p-4 flex flex-col justify-between';
                    card.innerHTML = `
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">${item.type}：${item.ID}</h3>
                            <p class="text-gray-700 mt-1">${item.Title}</p>
                            <p class="text-gray-500 mt-2 text-sm">Owner: ${item.OwnerEmail}</p>
                            <p class="text-gray-500 text-sm">Submitter: ${item.Submitter}</p>
                        </div>
                        <div class="mt-4 space-x-2">
                            <button data-id="${item.ID}" data-sheet="${item.sheetName}" class="btn-approve px-3 py-1 bg-green-500 text-white rounded text-sm">批准</button>
                            <button data-id="${item.ID}" data-sheet="${item.sheetName}" class="btn-reject px-3 py-1 bg-red-500 text-white rounded text-sm">駁回</button>
                        </div>
                    `;
                    approvalsListElem.appendChild(card);
                });
            }).getPendingApprovals(sessionToken);
        }

        // 處理批准/駁回 (Using event delegation)
        // Moved to global event listener at the end of the script

        /**
         * 載入並繪製 OKR 心智圖 - v15 動畫座標修正版
         */
        function loadMindmap() {
            const container = document.getElementById('mindmap-container');
            if (!container) { console.error("Mindmap container not found."); return; }
            container.innerHTML = '<p class="text-center text-gray-500 p-8">心智圖載入中...</p>';
            if (typeof d3 === 'undefined') { container.innerHTML = '<p class="text-center text-red-500 p-8">錯誤：D3.js 函式庫未載入。</p>'; return; }

            const width = container.clientWidth, height = container.clientHeight || 600;
            container.innerHTML = '';

            const svg = d3.select(container).append("svg").attr("width", width).attr("height", height);
            const g = svg.append("g");
            const zoom = d3.zoom().scaleExtent([0.1, 3]).on("zoom", () => { if (d3.event && d3.event.transform) g.attr("transform", d3.event.transform); });
            svg.call(zoom);

            const NODE_WIDTH = 230, NODE_HEIGHT = 70;
            // 為「衛星徽章」增加垂直間距，避免與上方節點重疊
            const treeLayout = d3.tree().nodeSize([NODE_HEIGHT + 45, NODE_WIDTH + 140]);

            google.script.run
                .withSuccessHandler(resStr => {
                    const parsedResponse = JSON.parse(resStr);
                    if (parsedResponse.error || !parsedResponse.mindmapData) { container.innerHTML = `<p>${parsedResponse.error || "後端資料錯誤。"}</p>`; return; }

                    const root = d3.hierarchy(parsedResponse.mindmapData);
                    const treeData = treeLayout(root);
                    const nodes = treeData.descendants();
                    const links = treeData.links();

                    const linkElements = g.append("g").attr("class", "links").selectAll("path.link").data(links).enter().append("path").attr("class", "link").attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));
                    const nodeElements = g.append("g").attr("class", "nodes").selectAll("g.node").data(nodes).enter().append("g").attr("class", d => `node ${(d.data && d.data.type) ? d.data.type : ''}`).attr("transform", d => `translate(${d.y},${d.x})`);

                    drawNodeElements(nodeElements);
                    updateNodeStyles(nodeElements);
                    attachEventListeners(nodeElements, linkElements);

                    fitAndCenter(g, width, height, zoom, svg);
                    window.d3Mindmap = { nodeElements, linkElements };
                })
                .withFailureHandler(err => container.innerHTML = `<p class="text-center text-red-500 p-8">載入資料失敗: ${err.message}</p>`)
                .getMindmapData(sessionToken);
        }

        function truncateText(text, maxLength) {
            if (typeof text !== 'string') return '';
            if (text.length <= maxLength) return text;
            return text.slice(0, maxLength).trim() + '...';
        }

        function drawNodeElements(selection) {
            const NODE_WIDTH = 230, NODE_HEIGHT = 70, PADDING = 12;
            const textStartX = -NODE_WIDTH / 2 + PADDING;

            selection.append("rect").attr("class", "card-bg").attr("width", NODE_WIDTH).attr("height", NODE_HEIGHT).attr("x", -NODE_WIDTH / 2).attr("y", -NODE_HEIGHT / 2).attr("rx", 8).style("fill", "#fff");
            selection.append("rect").attr("class", "status-ribbon").attr("width", 6).attr("height", NODE_HEIGHT).attr("x", -NODE_WIDTH / 2).attr("y", -NODE_HEIGHT / 2).attr("rx", 8).attr("ry", 8);
            
            const ICONS = { Objective: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z", KeyResult: "M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6zm10-8c-1.1 0-2-.9-2-2s.9-2 2 2 2 .9 2 2-.9 2-2 2z", Root: "M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" };
            selection.append("path").attr("class", "type-icon").attr("d", d => { if (!d.data || !d.data.type) return ''; if (d.data.type.includes("Objective")) return ICONS.Objective; if (d.data.type.includes("KeyResult")) return ICONS.KeyResult; if (d.data.type === "Root") return ICONS.Root; return ''; }).attr("transform", `translate(${-NODE_WIDTH/2 + PADDING}, ${-NODE_HEIGHT/2 + PADDING - 2}) scale(0.7)`);
            selection.append('text').attr("class", "id-text").attr("x", textStartX).attr("y", -NODE_HEIGHT / 2 + 18);
            selection.append('text').attr("class", "name-text").attr("x", textStartX).attr("y", 2);
            selection.append('text').attr("class", "sub-text").attr("x", textStartX).attr("y", NODE_HEIGHT / 2 - 12);
            
            const ringGroup = selection.filter(d => d.data && d.data.type && d.data.type.includes("KeyResult"))
                .append("g")
                .attr("class", "progress-ring")
                .attr("transform", `translate(${NODE_WIDTH / 2}, ${-NODE_HEIGHT / 2})`);

            const ringRadius = 14;
            const ringStroke = 4;
            ringGroup.append("path").attr("class", "ring-bg").attr("d", d3.arc().innerRadius(ringRadius - ringStroke).outerRadius(ringRadius).startAngle(0).endAngle(2 * Math.PI)).style("fill", "#e2e8f0");
            ringGroup.append("path").attr("class", "ring-fg").style("fill", "#4299e1");
            ringGroup.append("text").attr("class", "ring-text").attr("y", 4).attr("text-anchor", "middle").style("font-size", "10px").style("font-weight", "bold");
        }

        function updateNodeStyles(selection) {
            selection.select(".card-bg")
                .attr("stroke", d => (d.data && d.data.data && d.data.data.isUnfulfilled) ? '#e53e3e' : '#d2d6dc')
                .attr("stroke-width", d => (d.data && d.data.data && d.data.data.isUnfulfilled) ? 2 : 1);
                
            selection.select(".type-icon").style("fill", "#4a5568");
            selection.select(".status-ribbon").style("fill", d => { if (d.data && d.data.data) { if (d.data.data.isUnfulfilled) return '#f56565'; switch (d.data.data.Status) { case 'On Track': return '#48bb78'; case 'Off Track': return '#f6ad55'; case 'Rejected': return '#f56565'; case 'Draft': return '#a0aec0'; } } return 'transparent'; });
            
            const PADDING = 12, NODE_WIDTH = 230, textStartX = -NODE_WIDTH / 2 + PADDING;
            const nameLength = 15, subTextLength = 28;
            selection.each(function(d){ const hasIcon = d.data.type && (d.data.type.includes("Objective") || d.data.type.includes("KeyResult")); const startX = hasIcon ? textStartX + 24 : textStartX; d3.select(this).selectAll('.id-text, .name-text, .sub-text').attr('x', startX); });
            selection.select(".id-text").text(d => (d.data && d.data.id) ? d.data.id : '').style("font-size", "9px").style("fill", "#a0aec0");
            selection.select(".name-text").text(d => (d.data && d.data.name) ? truncateText(d.data.name, nameLength) : '').style("font-size", "14px").style("font-weight", "600").style("fill", "#2d3748");
            selection.select(".sub-text").text(d => { if (!d.data || !d.data.data) return ''; const ownerText = d.data.data.OwnerEmail ? `負責人:${d.data.data.OwnerEmail}` : ''; return truncateText(ownerText, subTextLength); }).style("font-size", "10px").style("fill", "#718096");
            
            selection.select(".ring-fg").attr("d", function(d) {
                const progress = (d.data && d.data.data && d.data.data.Progress) ? d.data.data.Progress / 100 : 0;
                const ringRadius = 14, ringStroke = 4;
                return d3.arc().innerRadius(ringRadius - ringStroke).outerRadius(ringRadius).startAngle(0).endAngle(progress * 2 * Math.PI)(d);
            });
            selection.select(".ring-text").text(d => `${(d.data && d.data.data.Progress) || 0}%`);
        }

        function attachEventListeners(nodeSelection, linkSelection) {
            nodeSelection.on("click", function (d) { if (!d.data || !d.data.id) return; if (d.data.type.includes("KeyResult")) { openKRDetailModal(d.data.id); } else if (d.data.type.includes("Objective")) { openCommentsModal(d.data.id); } }).style("cursor", "pointer");
            const tooltip = d3.select("body").append("div").attr("class", "d3-tooltip").style("opacity", 0);
            nodeSelection.on("mouseover", function (d) {
                const ancestors = d.ancestors(); const ancestorIds = new Set(ancestors.map(a => a.data.id));
                nodeSelection.classed("dimmed", n => !ancestorIds.has(n.data.id));
                linkSelection.classed("dimmed", l => !ancestorIds.has(l.source.data.id) || !ancestorIds.has(l.target.data.id)).filter(l => ancestorIds.has(l.source.data.id) && ancestorIds.has(l.target.data.id)).classed('highlight-path', true).raise();
                if (!d.data) return;
                tooltip.transition().duration(200).style("opacity", 1);
                let html = `<strong>${d.data.name || 'N/A'}</strong>`;
                if (d.data.data) { html += `<span>ID: ${d.data.id || 'N/A'}</span><span>負責人: ${d.data.data.OwnerEmail || 'N/A'}</span><span>截止日: 2025-09-30</span><hr/><span>${d.data.data.Description || ''}</span>`; }
                tooltip.html(html).style("left", (d3.event.pageX + 15) + "px").style("top", (d3.event.pageY - 15) + "px");
            }).on("mouseout", function () {
                nodeSelection.classed("dimmed", false);
                linkSelection.classed("dimmed", false).classed('highlight-path', false);
                tooltip.transition().duration(500).style("opacity", 0);
            });
        }

        function fitAndCenter(selection, width, height, zoom, svg) {
            if (!selection.node() || !selection.node().getBBox) return;
            const bounds = selection.node().getBBox();
            if (bounds.width === 0 || bounds.height === 0) return; 
            const scale = 0.85 / Math.max(bounds.width / width, bounds.height / height);
            const newX = (width / 2) - scale * (bounds.x + bounds.width / 2);
            const newY = (height / 2) - scale * (bounds.y + bounds.height / 2);
            const initialTransform = d3.zoomIdentity.translate(newX, newY).scale(scale);
            svg.transition().duration(750).call(zoom.transform, initialTransform);
        }

        // 33. 報表與儀表板 (Chart.js)
        let chartPredictionInstance = null;
        let chartOverviewInstance = null;
        let chartDeptRankingInstance = null;
        let chartHeatmapInstance = null;

        function destroyCharts() {
            if (chartPredictionInstance) { chartPredictionInstance.destroy(); chartPredictionInstance = null; }
            if (chartOverviewInstance) { chartOverviewInstance.destroy(); chartOverviewInstance = null; }
            if (chartDeptRankingInstance) { chartDeptRankingInstance.destroy(); chartDeptRankingInstance = null; }
            if (chartHeatmapInstance) { chartHeatmapInstance.destroy(); chartHeatmapInstance = null; }
        }

        function loadReports() {
            destroyCharts();

            google.script.run.withSuccessHandler(res => {
                let d = JSON.parse(res).predictionData;
                const ctx = document.getElementById('chart-prediction').getContext('2d');
                chartPredictionInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: d.labels,
                        datasets: [
                            { label: '實際進度', data: d.actual, borderColor: '#36A2EB', tension: 0.1, fill: false },
                            { label: '預測進度', data: d.predicted, borderColor: '#FF6384', borderDash: [5, 5], tension: 0.1, fill: false }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'KR進度預測' } }, scales: { y: { beginAtZero: true, max: 100 } } }
                });
            }).getAIPredictionData(sessionToken);

            google.script.run.withSuccessHandler(res => {
                let overviewData = JSON.parse(res).overview;
                let deptRankingData = JSON.parse(res).deptRanking;

                const ctxOverview = document.getElementById('chart-overview').getContext('2d');
                chartOverviewInstance = new Chart(ctxOverview, {
                    type: 'bar',
                    data: {
                        labels: overviewData.labels,
                        datasets: [{ label: '達成率(%)', data: overviewData.data, backgroundColor: '#4FD1C5' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
                });

                const ctxDeptRanking = document.getElementById('chart-dept-ranking').getContext('2d');
                chartDeptRankingInstance = new Chart(ctxDeptRanking, {
                    type: 'bar',
                    data: {
                        labels: deptRankingData.labels,
                        datasets: [{ label: '部門達成率(%)', data: deptRankingData.data, backgroundColor: '#B794F4' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
                });
            }).getDashboardOverviewData(sessionToken);

            google.script.run.withSuccessHandler(res => {
                let h = JSON.parse(res).heatmap;
                const ctxHeatmap = document.getElementById('chart-heatmap').getContext('2d');
                chartHeatmapInstance = new Chart(ctxHeatmap, {
                    type: 'bar',
                    data: {
                        labels: h.labelsX,
                        datasets: h.labelsY.map((y, idx) => ({
                            label: y,
                            data: h.matrix[idx],
                            backgroundColor: `rgba(${(idx * 80) % 255},${(idx * 40) % 255},200,0.8)`
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: true, title: { display: true, text: '公司 Objectives' } },
                            y: { stacked: true, beginAtZero: true, title: { display: true, text: '部門' } }
                        },
                        plugins: { tooltip: { mode: 'index', intersect: false } }
                    }
                });
            }).getAlignmentHeatmapData(sessionToken);
        }

        // 34. 留言功能
        function loadComments(entityId, containerId) {
            const commentsContainer = document.getElementById(containerId);
            if (!commentsContainer) { console.error(`Error: Comments container element '${containerId}' not found.`); return; }
            commentsContainer.innerHTML = '<p class="text-gray-500">載入中...</p>';

            google.script.run.withSuccessHandler(resStr => {
                const res = JSON.parse(resStr);
                if (res.error) {
                    commentsContainer.innerHTML = `<p class="text-red-500">${res.error}</p>`;
                    return;
                }
                const list = res.comments;
                let html = '';
                list.forEach(c => {
                    html += `<div class="border-b py-2"><p class="text-gray-800 text-sm">${c.CommentText}</p><p class="text-gray-500 text-xs">${c.Author} @ ${new Date(c.Timestamp).toLocaleString()}</p></div>`;
                });
                if (!list.length) html = `<p class="text-gray-500 text-sm">目前尚無留言。</p>`;
                commentsContainer.innerHTML = html;
            }).getComments(sessionToken, entityId);
        }

        function openCommentsModal(entityId) {
            const html = `
                <h3 class="text-xl font-semibold mb-4">留言 - ${entityId}</h3>
                <div id="comments-container" class="max-h-[50vh] overflow-y-auto scrollbar-thin p-2 bg-gray-50 rounded mb-4"></div>
                <div class="space-y-2">
                    <textarea id="new-comment" rows="3" class="w-full p-2 border rounded" placeholder="輸入留言"></textarea>
                    <button id="btn-submit-comment" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">送出留言</button>
                </div>
                <div class="mt-4 text-right">
                    <button id="btn-close-comments" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">關閉</button>
                </div>
            `;
            showModal(html);
            setTimeout(() => {
                loadComments(entityId, 'comments-container');
                document.getElementById('btn-close-comments')?.addEventListener('click', hideModal);
                document.getElementById('btn-submit-comment')?.addEventListener('click', () => {
                    const text = document.getElementById('new-comment').value.trim();
                    if (!text) return;
                    google.script.run.withSuccessHandler(res => {
                        alert(res.message);
                        document.getElementById('new-comment').value = '';
                        loadComments(entityId, 'comments-container');
                    }).addComment(sessionToken, { EntityID: entityId, CommentText: text });
                });
            }, 0);
        }

        // KR 詳情 Modal (包含留言功能)
        function openKRDetailModal(krId) {
            google.script.run.withSuccessHandler(resStr => {
                const res = JSON.parse(resStr);
                const allKRs = res.keyResults;
                const kr = allKRs.find(x => x.ID === krId);

                if (!kr) { alert('找不到該 KR'); return; }

                const statusMap = { 'On Track': '良好', 'Off Track': '有風險', 'Completed': '已完成' };

                const html = `
                    <h3 class="text-xl font-semibold mb-4">Key Result 詳情 - ${kr.ID}</h3>
                    <div class="space-y-2 mb-4 p-2 bg-gray-50 rounded">
                        <p><strong>所屬目標 ID:</strong> ${kr.ObjectiveID}</p>
                        <p><strong>描述:</strong> ${kr.Description}</p>
                        <p><strong>負責人:</strong> ${kr.OwnerEmail}</p>
                        <p><strong>起始值:</strong> ${kr.StartValue || 0} ${kr.Unit || ''}</p>
                        <p><strong>目標值:</strong> ${kr.TargetValue || 0} ${kr.Unit || ''}</p>
                        <p><strong>目前值:</strong> ${kr.CurrentValue || 0} ${kr.Unit || ''}</p>
                        <p><strong>進度:</strong> ${kr.Progress || 0}%</p>
                        <p><strong>狀態:</strong> ${statusMap[kr.Status] || kr.Status}</p>
                    </div>
                    <h4 class="text-lg font-semibold mb-2">留言:</h4>
                    <div id="kr-detail-comments-container" class="max-h-[30vh] overflow-y-auto scrollbar-thin p-2 bg-gray-100 rounded mb-4"></div>
                    <div class="space-y-2">
                        <textarea id="new-kr-detail-comment" rows="3" class="w-full p-2 border rounded" placeholder="輸入留言"></textarea>
                        <button id="btn-submit-kr-detail-comment" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">送出留言</button>
                    </div>
                    <div class="mt-4 text-right">
                        <button id="btn-close-kr-detail" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">關閉</button>
                    </div>
                `;
                showModal(html);
                setTimeout(() => {
                    loadComments(krId, 'kr-detail-comments-container');
                    document.getElementById('btn-close-kr-detail')?.addEventListener('click', hideModal);
                    document.getElementById('btn-submit-kr-detail-comment')?.addEventListener('click', () => {
                        const text = document.getElementById('new-kr-detail-comment').value.trim();
                        if (!text) return;
                        google.script.run.withSuccessHandler(resComment => {
                            alert(resComment.message);
                            document.getElementById('new-kr-detail-comment').value = '';
                            loadComments(krId, 'kr-detail-comments-container');
                        }).addComment(sessionToken, { EntityID: krId, CommentText: text });
                    });
                }, 0);
            }).getKeyResultsByObjective(sessionToken, '__ALL_COMPANY__');
        }

        // 批次更新 KR 進度 Modal (新功能框架)
        function openBatchUpdateKRModal(type) {
            let title = '';
            let filterType = '';
            if (type === 'company') { title = '批次更新公司級 KR 進度'; filterType = '__ALL_COMPANY__'; }
            else if (type === 'dept') { title = '批次更新部門級 KR 進度'; filterType = '__ALL_DEPT__'; }
            else if (type === 'personal') { title = '批次更新個人級 KR 進度'; filterType = '__ALL_PERSONAL__'; }

            const html = `
                <h3 class="text-xl font-semibold mb-4">${title}</h3>
                <div id="batch-update-kr-list-container" class="space-y-4 overflow-y-auto max-h-[60vh] scrollbar-thin p-2 bg-white rounded">
                    <p class="text-gray-500">載入中...</p>
                </div>
                <div class="flex justify-end space-x-2 pt-4 border-t mt-4">
                    <button type="button" id="btn-cancel-batch-update" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">取消</button>
                    <button type="submit" id="btn-submit-batch-update" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">批次更新</button>
                </div>
            `;
            showModal(html);
            setTimeout(() => {
                const container = document.getElementById('batch-update-kr-list-container');
                const btnCancelBatchUpdate = document.getElementById('btn-cancel-batch-update');
                const btnSubmitBatchUpdate = document.getElementById('btn-submit-batch-update');

                if (!container || !btnCancelBatchUpdate || !btnSubmitBatchUpdate) {
                     console.error("Batch update modal elements not found after setTimeout.");
                     alert("載入批次更新表單失敗，請重試。");
                     hideModal();
                     return;
                }

                btnCancelBatchUpdate.addEventListener('click', hideModal);

                google.script.run.withSuccessHandler(resStr => {
                    const res = JSON.parse(resStr);
                    if (res.error) {
                        container.innerHTML = `<p class="text-red-500">${res.error}</p>`;
                        return;
                    }
                    const krList = res.keyResults;
                    if (!krList.length) {
                        container.innerHTML = `<p class="text-gray-500">目前沒有可供批次更新的 KR。</p>`;
                        btnSubmitBatchUpdate.disabled = true;
                        return;
                    }

                    let krHtml = '';
                    krList.forEach(kr => {
                        krHtml += `
                            <div class="border rounded p-3 bg-gray-50 mb-2" data-kr-id="${kr.ID}">
                                <p class="font-medium text-gray-800">${kr.ID}：${kr.Description}</p>
                                <p class="text-gray-600 text-sm">Owner: ${kr.OwnerEmail} | 目標值: ${kr.TargetValue} ${kr.Unit}</p>
                                <div class="mt-2 flex items-center space-x-2">
                                    <label for="batch-current-${kr.ID}" class="text-gray-700 text-sm">目前值:</label>
                                    <input type="number" id="batch-current-${kr.ID}" value="${kr.CurrentValue || 0}" class="w-24 p-1 border rounded text-sm" data-original-value="${kr.CurrentValue || 0}">
                                    <label for="batch-progress-${kr.ID}" class="text-gray-700 text-sm">進度 (%):</label>
                                    <input type="number" id="batch-progress-${kr.ID}" value="${kr.Progress || 0}" class="w-24 p-1 border rounded text-sm" data-original-value="${kr.Progress || 0}">
                                    <span class="text-gray-600 text-sm ml-auto">(${kr.Unit})</span>
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = krHtml;

                    btnSubmitBatchUpdate.addEventListener('click', () => {
                        const updates = [];
                        container.querySelectorAll('[data-kr-id]').forEach(krDiv => {
                            const krId = krDiv.dataset.krId;
                            const newCurrentValue = Number(krDiv.querySelector(`#batch-current-${krId}`).value);
                            const newProgress = Number(krDiv.querySelector(`#batch-progress-${krId}`).value);
                            
                            const originalCurrentValue = Number(krDiv.querySelector(`#batch-current-${krId}`).dataset.originalValue);
                            const originalProgress = Number(krDiv.querySelector(`#batch-progress-${krId}`).dataset.originalValue);

                            if (newCurrentValue !== originalCurrentValue || newProgress !== originalProgress) {
                                const originalKr = krList.find(k => k.ID === krId);
                                if (originalKr) {
                                    updates.push({
                                        ID: krId,
                                        Description: originalKr.Description,
                                        OwnerEmail: originalKr.OwnerEmail,
                                        StartValue: originalKr.StartValue,
                                        TargetValue: originalKr.TargetValue,
                                        CurrentValue: newCurrentValue,
                                        Progress: newProgress,
                                        Unit: originalKr.Unit,
                                        Status: originalKr.Status
                                    });
                                }
                            }
                        });

                        if (updates.length === 0) {
                            alert('沒有檢測到任何 KR 進度變更。');
                            return;
                        }
                        
                        google.script.run.withSuccessHandler(res => {
                            alert(res.message);
                            hideModal();
                            if (type === 'company') loadCompanyObjectives(document.getElementById('search-company').value.trim());
                            else if (type === 'dept') loadDepartmentObjectives(document.getElementById('search-dept').value.trim());
                            else if (type === 'personal') loadPersonalObjectives(document.getElementById('search-personal').value.trim());
                        }).batchUpdateKeyResults(sessionToken, updates);
                    });

                }).getKeyResultsByObjective(sessionToken, filterType);
            }, 0);
        }

        document.addEventListener('click', (e) => {
            if (e.target.closest('.objective-header')) {
                const header = e.target.closest('.objective-header');
                const arrow = header.querySelector('.collapse-arrow');
                const krListContainer = header.parentElement.querySelector('.kr-list-container');

                if (krListContainer && arrow) {
                    $(krListContainer).slideToggle(200, function() {
                        arrow.classList.toggle('expanded', $(this).is(':visible'));
                    });
                }
            }
            
            if (e.target.matches('#btn-create-company')) { openCreateCompanyModal(); }
            if (e.target.matches('#btn-create-dept')) { openCreateDeptModal(); }
            if (e.target.matches('#btn-create-personal')) { openCreatePersonalOModal(); }

            if (e.target.matches('#btn-batch-update-company-KR')) { openBatchUpdateKRModal('company'); }
            if (e.target.matches('#btn-batch-update-dept-KR')) { openBatchUpdateKRModal('dept'); }
            if (e.target.matches('#btn-batch-update-personal-KR')) { openBatchUpdateKRModal('personal'); }

            if (e.target.matches('.btn-create-KR')) {
                const objectiveId = e.target.getAttribute('data-id');
                if (objectiveId.startsWith('C-')) openCreateCompanyKRModal(objectiveId);
                else if (objectiveId.startsWith('D-')) openCreateDeptKRModal(objectiveId);
                else if (objectiveId.startsWith('P-')) openCreatePersonalKRModal(objectiveId);
            }
            if (e.target.matches('.btn-edit-O')) {
                const objectiveId = e.target.getAttribute('data-id');
                const type = e.target.getAttribute('data-type');
                if (type === 'company') openEditCompanyOModal(objectiveId);
                else if (type === 'dept') openEditDeptOModal(objectiveId);
                else if (type === 'personal') openEditPersonalOModal(objectiveId);
            }
            if (e.target.matches('.btn-delete-O')) {
                const objectiveId = e.target.getAttribute('data-id');
                const type = e.target.getAttribute('data-type');
                if (confirm(`確定要刪除 ${type} 目標 ${objectiveId} 及其所有 KR 嗎？此操作不可復原。`)) {
                    if (type === 'company') { google.script.run.withSuccessHandler(res => { alert(res.message); loadCompanyObjectives(document.getElementById('search-company').value.trim()); }).deleteCompanyObjective(sessionToken, objectiveId); }
                    else if (type === 'dept') { google.script.run.withSuccessHandler(res => { alert(res.message); loadDepartmentObjectives(document.getElementById('search-dept').value.trim()); }).deleteDepartmentObjective(sessionToken, objectiveId); }
                    else if (type === 'personal') { google.script.run.withSuccessHandler(res => { alert(res.message); loadPersonalObjectives(document.getElementById('search-personal').value.trim()); }).deleteMyObjective(sessionToken, objectiveId); }
                }
            }
            if (e.target.matches('.btn-submit-O')) {
                const objectiveId = e.target.getAttribute('data-id');
                const sheetName = e.target.getAttribute('data-sheet');
                const approverEmail = prompt('請輸入審批者 Email：').trim();
                if (!approverEmail) return;
                google.script.run.withSuccessHandler(res => {
                    alert(res.message);
                    loadCompanyObjectives(document.getElementById('search-company').value.trim());
                    loadDepartmentObjectives(document.getElementById('search-dept').value.trim());
                    loadPersonalObjectives(document.getElementById('search-personal').value.trim());
                }).submitObjectiveForApproval(sessionToken, { sheetName, objectiveId, approverEmail });
            }

            if (e.target.matches('.btn-edit-KR')) { openEditKRModal(e.target.getAttribute('data-id')); }
            if (e.target.matches('.btn-detail-KR')) { openKRDetailModal(e.target.getAttribute('data-id')); }

            if (e.target.matches('#btn-delete-kr-from-modal')) {
                const krId = e.target.getAttribute('data-id');
                const objectiveId = e.target.getAttribute('data-objective-id');
                if (confirm(`確定要刪除 KR ${krId} 嗎？此操作無法復原。`)) {
                    google.script.run.withSuccessHandler(res => {
                        alert(res.message);
                        hideModal();
                        if (objectiveId.startsWith('C-')) loadCompanyObjectives(document.getElementById('search-company').value.trim());
                        else if (objectiveId.startsWith('D-')) loadDepartmentObjectives(document.getElementById('search-dept').value.trim());
                        else if (objectiveId.startsWith('P-')) loadPersonalObjectives(document.getElementById('search-personal').value.trim());
                    }).deleteKeyResult(sessionToken, krId);
                }
            }

            if (e.target.matches('.btn-approve')) {
                const objId = e.target.getAttribute('data-id');
                const sheetName = e.target.getAttribute('data-sheet');
                google.script.run.withSuccessHandler(res => {
                    alert(res.message);
                    loadApprovals();
                    loadCompanyObjectives(document.getElementById('search-company').value.trim());
                    loadDepartmentObjectives(document.getElementById('search-dept').value.trim());
                    loadPersonalObjectives(document.getElementById('search-personal').value.trim());
                }).approveObjective(sessionToken, { sheetName, objectiveId: objId });
            }
            if (e.target.matches('.btn-reject')) {
                const objId = e.target.getAttribute('data-id');
                const sheetName = e.target.getAttribute('data-sheet');
                const reason = prompt('請輸入駁回原因：').trim();
                if (reason === null || reason === '') return;
                google.script.run.withSuccessHandler(res => {
                    alert(res.message);
                    loadApprovals();
                    loadCompanyObjectives(document.getElementById('search-company').value.trim());
                    loadDepartmentObjectives(document.getElementById('search-dept').value.trim());
                    loadPersonalObjectives(document.getElementById('search-personal').value.trim());
                }).rejectObjective(sessionToken, { sheetName, objectiveId: objId, reason });
            }

            if (e.target.matches('.btn-comments-O')) { openCommentsModal(e.target.getAttribute('data-id')); }
            if (e.target.matches('.btn-comments-KR')) { openCommentsModal(e.target.getAttribute('data-id')); }
        });

    </script>
</body>

</html>
